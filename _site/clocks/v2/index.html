<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V2 Clock Tool</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>form-field {
    display: block;
    margin-block: var(--thin);
  }
clock-drive {
    display: block;
    --part-color: var(--wind-color);
  }
clock-wheel {
    display: block;
    --part-color: var(--wheel-color);
  }
clock-pinion {
    display: block;
    --part-color: var(--pinion-color);
  }
clock-arbor dl {
    margin-block: var(--thin);
  }
.wdlmvvuc9{--wind-color: var(--teal-9);--center-color: var(--indigo-9);--escape-color: var(--pink-9);--wheel-color: var(--blue-9);--pinion-color: var(--orange-9);display:block;max-width:70ch;margin:0 auto}@media (prefers-color-scheme:dark){.wdlmvvuc9{--wind-color: var(--teal-3);--center-color: var(--indigo-3);--escape-color: var(--pink-3);--wheel-color: var(--blue-3);--pinion-color: var(--orange-3)}}.wdlmvvuc9[data-is=wind]{--arbor-color: var(--wind-color)}.wdlmvvuc9[data-is=center]{--arbor-color: var(--center-color)}.wdlmvvuc9[data-is=escape]{--arbor-color: var(--escape-color)}.wdlmvvuc9 fieldset{border-color:var(--arbor-color)}.wdlmvvuc9 legend{color:var(--arbor-color)}.wdlmvvuc9 [data-parts]{display:grid;gap:var(--thin);> * {
      border-inline-start: thick solid var(--part-color, var(--gray-6));
      padding-inline-start: var(--medium);
    }}.wdlmvvuc9 [data-out=arbor]{border-block-start:thin dotted;margin-block-start:var(--gap);padding-block-start:var(--gap)}
#train-settings {
    border-style: dotted;
  }

  split-train {
    display: grid;
    gap: var(--gap);
    grid-template-columns: repeat(auto-fit, minmax(min(30ch, 100%), 1fr));
    justify-content: center;
  }</style>
</head>
<body>
  <header>
    <h1>V2 Clock Tool</h1>
  </header>

  <main><clock-train><h2>Going Train</h2>

<fieldset id="train-settings">
  <legend>general settings</legend>
  <form-field>
    <label for="size-unit">
      size
    </label>
    <select name="size-unit" id="size-unit">
      <option value="mm" selected>mm</option>
      <option value="in">in</option>
    </select>
  




</form-field>

  <form-field>
    <label for="force-unit">
      force
    </label>
    <select name="force-unit" id="force-unit">
      <option value="lb" selected>lb</option>
      <option value="kg">kg</option>
    </select>
  




</form-field>
</fieldset>



  <clock-arbor id="wind" data-is="wind" class="wdlmvvuc9"><fieldset>
  <legend>
    <span>wind</span>
    arbor
  </legend>

  <div class="parts">
    
    <clock-drive><form-field>
  <label for="drive-webc-Pghy4">
    drive weight
  </label>
  <input value="5" id="drive-webc-Pghy4" type="number" min="2" max="20" class="force">
  <output for="force-unit">…</output>





</form-field>

<form-field>
  <label for="ratchet-size">
    ratchet size
  </label>
  <input value="1" id="ratchet-size" type="number" min="0" max="50">
  <output for="size-unit">…</output>





</form-field>


</clock-drive>

    <clock-wheel id="great-wheel" data-od data-teeth="60"><form-field>
  <label for="wheel-webc-F0mme">great-wheel</label>
  <input id="wheel-webc-F0mme" value="60" type="number" min="20" max="120" class="teeth">





</form-field>







</clock-wheel>
  
  </div>

  
</fieldset>







</clock-arbor>

  <clock-arbor id="second" data-drive="great-wheel" class="wdlmvvuc9"><fieldset>
  <legend>
    <span>second</span>
    arbor
  </legend>

  <div class="parts">
    
    <clock-pinion data-for="great-wheel" data-leaves="20"><form-field>
  <label for="pinion-great-wheel">pinion (great-wheel)</label>
  <input id="pinion-great-wheel" value="20" type="number" min="6" max="30" class="teeth">





</form-field>

<dl data-out="pinion">
  <div>
    <dt>pitch diameter</dt>
    <dd>
      <output data-show="pd">…</output>
      <output for="size-unit">…</output>
    </dd>
  </div>
</dl>





</clock-pinion>

    <clock-wheel id="second-wheel" data-teeth="64"><form-field>
  <label for="wheel-webc-5XZKI">second-wheel</label>
  <input id="wheel-webc-5XZKI" value="64" type="number" min="20" max="120" class="teeth">





</form-field>







</clock-wheel>
  
  </div>

  <dl data-out="arbor">
    <div>
      <dt>step ratio</dt>
      <dd>
        <output data-show="ratio">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive ratio</dt>
      <dd>
        <output data-show="drive">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive force</dt>
      <dd>
        <output data-show="force">…</output>
        <output for="force-unit">…</output>
      </dd>
    </div>
    <div>
      <dt>timing</dt>
      <dd>
        <output data-show="rph">…</output>
        <span class="unit">rph</span>
      </dd>
    </div>
  </dl>
</fieldset>







</clock-arbor>

  <split-train>
    <train-part>

      <clock-arbor id="center" data-is="center" data-drive="second-wheel" class="wdlmvvuc9"><fieldset>
  <legend>
    <span>center</span>
    arbor
  </legend>

  <div class="parts">
    
        <clock-pinion data-for="second-wheel" data-leaves="8"><form-field>
  <label for="pinion-second-wheel">pinion (second-wheel)</label>
  <input id="pinion-second-wheel" value="8" type="number" min="6" max="30" class="teeth">





</form-field>

<dl data-out="pinion">
  <div>
    <dt>pitch diameter</dt>
    <dd>
      <output data-show="pd">…</output>
      <output for="size-unit">…</output>
    </dd>
  </div>
</dl>





</clock-pinion>

        <clock-wheel id="center-wheel" data-teeth="60"><form-field>
  <label for="wheel-webc-NZJ-q">center-wheel</label>
  <input id="wheel-webc-NZJ-q" value="60" type="number" min="20" max="120" class="teeth">





</form-field>







</clock-wheel>
      
  </div>

  <dl data-out="arbor">
    <div>
      <dt>step ratio</dt>
      <dd>
        <output data-show="ratio">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive ratio</dt>
      <dd>
        <output data-show="drive">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive force</dt>
      <dd>
        <output data-show="force">…</output>
        <output for="force-unit">…</output>
      </dd>
    </div>
    <div>
      <dt>timing</dt>
      <dd>
        <output data-show="rph">1</output>
        <span class="unit">rph</span>
      </dd>
    </div>
  </dl>
</fieldset>







</clock-arbor>

    </train-part>
    <train-part>

      <clock-arbor id="third" data-drive="second-wheel" class="wdlmvvuc9"><fieldset>
  <legend>
    <span>third</span>
    arbor
  </legend>

  <div class="parts">
    
        <clock-pinion data-for="second-wheel" data-leaves="8"><form-field>
  <label for="pinion-second-wheel">pinion (second-wheel)</label>
  <input id="pinion-second-wheel" value="8" type="number" min="6" max="30" class="teeth">





</form-field>

<dl data-out="pinion">
  <div>
    <dt>pitch diameter</dt>
    <dd>
      <output data-show="pd">…</output>
      <output for="size-unit">…</output>
    </dd>
  </div>
</dl>





</clock-pinion>

        <clock-wheel id="third-wheel" data-teeth="60"><form-field>
  <label for="wheel-webc-IjOGP">third-wheel</label>
  <input id="wheel-webc-IjOGP" value="60" type="number" min="20" max="120" class="teeth">





</form-field>







</clock-wheel>
      
  </div>

  <dl data-out="arbor">
    <div>
      <dt>step ratio</dt>
      <dd>
        <output data-show="ratio">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive ratio</dt>
      <dd>
        <output data-show="drive">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive force</dt>
      <dd>
        <output data-show="force">…</output>
        <output for="force-unit">…</output>
      </dd>
    </div>
    <div>
      <dt>timing</dt>
      <dd>
        <output data-show="rph">…</output>
        <span class="unit">rph</span>
      </dd>
    </div>
  </dl>
</fieldset>







</clock-arbor>

      <clock-arbor id="escape" data-is="escape" data-drive="third-wheel" class="wdlmvvuc9"><fieldset>
  <legend>
    <span>escape</span>
    arbor
  </legend>

  <div class="parts">
    
        <clock-pinion data-for="third-wheel" data-leaves="8"><form-field>
  <label for="pinion-third-wheel">pinion (third-wheel)</label>
  <input id="pinion-third-wheel" value="8" type="number" min="6" max="30" class="teeth">





</form-field>

<dl data-out="pinion">
  <div>
    <dt>pitch diameter</dt>
    <dd>
      <output data-show="pd">…</output>
      <output for="size-unit">…</output>
    </dd>
  </div>
</dl>





</clock-pinion>

        <clock-wheel id="escape-wheel" data-teeth="30"><form-field>
  <label for="wheel-webc-Gqj0z">escape-wheel</label>
  <input id="wheel-webc-Gqj0z" value="30" type="number" min="20" max="120" class="teeth">





</form-field>







</clock-wheel>
      
  </div>

  <dl data-out="arbor">
    <div>
      <dt>step ratio</dt>
      <dd>
        <output data-show="ratio">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive ratio</dt>
      <dd>
        <output data-show="drive">…</output>
        <span class="unit">: 1</span>
      </dd>
    </div>
    <div>
      <dt>drive force</dt>
      <dd>
        <output data-show="force">…</output>
        <output for="force-unit">…</output>
      </dd>
    </div>
    <div>
      <dt>timing</dt>
      <dd>
        <output data-show="rph">…</output>
        <span class="unit">rph</span>
      </dd>
    </div>
  </dl>
</fieldset>







</clock-arbor>

    </train-part>
  </split-train>


<dl class="out">
  <dt>Arbor Count</dt>
  <dd><output class="arbor-count">…</output></dd>
</dl>




</clock-train>
</main>

  <script>window.customElements.define('form-field', class extends HTMLElement {
    connectedCallback() { }
  });
window.customElements.define('clock-wheel', class extends HTMLElement {
    connectedCallback() {

    }
  });
window.customElements.define('clock-pinion', class extends HTMLElement {
    connectedCallback() {

    }
  });
window.customElements.define('clock-arbor', class extends HTMLElement {
    connectedCallback() {
      // utils
      const ish = (n, d = 4) => {
        const f = Math.pow(10, d);
        return Math.round(n * f) / f;
      };

      const name = (el) => el.tagName.toLowerCase().split('-').at(-1);

      const mapOutput = (el, map = {}) => {
        el.querySelectorAll(`:scope [data-out=${name(el)}] [data-show]`)
          .forEach((out) => { map[out.dataset.show] = out; });

        return map;
      };

      // elements
      const output = mapOutput(this);

      // drive
      const drive = {
        from: document.getElementById(this.dataset.drive),
        to: this.querySelector(`:scope .parts [data-for=${this.dataset.drive}]`),
      };

      if (drive.from && drive.to) {
        const fromInput = drive.from.querySelector(':scope .teeth');
        const toInput = drive.to.querySelector(':scope .teeth');

        const driveArbor = drive.from.closest('clock-arbor');
        const driveOut = driveArbor.dataset.is === 'wind'
          ? {
            ratio: { value: 1 },
            force: driveArbor.querySelector(':scope input.force'),
          }
          : mapOutput(driveArbor);

        const getRatio = () => parseInt(fromInput.value) / parseInt(toInput.value);
        const getDrive = () => getRatio() * parseFloat(driveOut.ratio.value);
        const getForce = () => parseFloat(driveOut.force.value) / getRatio();

        const setRatio = () => { output.ratio.value = ish(getRatio()); };
        const setDrive = () => { output.drive.value = ish(getDrive()); };
        const setForce = () => { output.force.value = ish(getForce()); };

        const updateArbor = () => {
          setRatio();
          setDrive();
          setForce();
        };

        // drive events
        updateArbor();
        this.addEventListener('change', (e) => { updateArbor(); });
        driveArbor.addEventListener('change', (e) => {
          updateArbor();
        });

        const driveChange = new MutationObserver((mutationList, observer) => {
          updateArbor();
        });

        driveArbor.querySelectorAll(':scope output').forEach((out) => {
          driveChange.observe(out, { childList: true });
        });

        // timing events
        const centerArbor = this
          .closest('clock-train').querySelector(':scope [data-is=center]');
        const centerDrive = centerArbor
          .querySelector(':scope [data-out=arbor] [data-show=drive]');

        const setRph = () => {
          if (centerDrive.value) {
            const rph = getDrive() / parseFloat(centerDrive.value);
            output.rph.value = ish(rph);
          }
        }

        if (centerArbor !== this) {
          setRph();
          centerArbor.addEventListener('change', (e) => { setRph(); });

          const centerChange = new MutationObserver((mutationList, observer) => {
            setRph();
          });

          centerChange.observe(centerDrive, { childList: true });
        }
      }
    }
  });
window.customElements.define('clock-train', class extends HTMLElement {
    connectedCallback() {
      // elements
      const input = {
        forceUnit: this.querySelector(':scope #force-unit'),
        sizeUnit: this.querySelector(':scope #size-unit'),
      };

      const output = {
        arborCount: this.querySelector(':scope dl .arbor-count'),
        forceUnit: document.querySelectorAll(':scope output[for=force-unit]'),
        sizeUnit: document.querySelectorAll(':scope output[for=size-unit]'),
      };

      // counting arbors
      const countArbors = () => this.querySelectorAll(':scope clock-arbor').length;
      const wheelCount = () => { output.arborCount.value = countArbors(); }

      // updating unit
      const forceUnit = () =>
        output.forceUnit.forEach((out) => out.value = input.forceUnit.value);

      const sizeUnit = () =>
        output.sizeUnit.forEach((out) => out.value = input.sizeUnit.value);

      // event listeners
      input.forceUnit.addEventListener('input', (e) => { forceUnit(); });
      input.sizeUnit.addEventListener('input', (e) => { sizeUnit(); });

      // general updates
      const doUpdate = () => {
        forceUnit();
        sizeUnit();
        wheelCount();
      }

      doUpdate();

      const trainChange = new MutationObserver((mutationList, observer) => {
        doUpdate();
      });

      trainChange.observe(this, { childList: true });
    }
  });</script>


</body>
</html>